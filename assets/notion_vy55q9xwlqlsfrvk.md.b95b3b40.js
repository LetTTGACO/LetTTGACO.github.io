import{_ as s,c as n,o as a,a as l}from"./app.1f26d752.js";const E=JSON.parse('{"title":"持续集成","description":"","frontmatter":{"sort":230,"urlname":"vy55q9xwlqlsfrvk","catalog":"进阶玩法","tags":"Elog-Docs","title":"持续集成","date":"2023-04-06 21:31:00","updated":"2024-01-16 23:02:00"},"headers":[],"relativePath":"notion/vy55q9xwlqlsfrvk.md","lastUpdated":1705429395000}'),p={name:"notion/vy55q9xwlqlsfrvk.md"},o=l(`<h1 id="持续集成" tabindex="-1">持续集成 <a class="header-anchor" href="#持续集成" aria-hidden="true">#</a></h1><h2 id="自动化流程" tabindex="-1">自动化流程 <a class="header-anchor" href="#自动化流程" aria-hidden="true">#</a></h2><p><img src="https://blogimagesrep-1257180516.cos.ap-guangzhou.myqcloud.com/elog-docs-images/033cd7c598f97adac9b4d2a71f0d7835.png" alt="Untitled.png"></p><h2 id="语雀示例" tabindex="-1">语雀示例 <a class="header-anchor" href="#语雀示例" aria-hidden="true">#</a></h2><p><strong>语雀 + webhooks + serverless api + GitHub Actions + Github Pages 持续集成</strong></p><p><img src="https://blogimagesrep-1257180516.cos.ap-guangzhou.myqcloud.com/elog-docs-images/93e5eae8d73452e3043e9845b627be8d.png" alt="Untitled.png"></p><h3 id="语雀-webhooks" tabindex="-1">语雀 webhooks <a class="header-anchor" href="#语雀-webhooks" aria-hidden="true">#</a></h3><p>在语雀知识库 - 更多设置 - 消息推送中可配置语雀webhooks，填写一个支持POST请求的APi链接即可（这里以serverless api为例）。当文档更新时，语雀会调用这个API进行推送</p><blockquote><p>令人遗憾的是，语雀将 webhooks 收费了<br> 未开通会员的语雀小伙伴可直接手动调用API触发Github Actions进行自动化构建&amp;部署<br> ⚠️ 知识库配置了「自动发布」功能后，文档的 更新/发布 操作暂不会发送 webhooks</p></blockquote><p><img src="https://blogimagesrep-1257180516.cos.ap-guangzhou.myqcloud.com/elog-docs-images/543de121db94bf2456b9973017219f3a.png" alt="Untitled.png"></p><h3 id="serverless-api" tabindex="-1"><strong>serverless api</strong> <a class="header-anchor" href="#serverless-api" aria-hidden="true">#</a></h3><p>为了方便，这里提供一个部署在Vercel的免费公用的<a href="https://github.com/elog-x/serverless-api" target="_blank" rel="noreferrer">ServerlessAPI</a></p><p>将其填入语雀Webhooks中即可</p><blockquote><p>未开通会员的语雀小伙伴可直接手动调用此API触发Github Actions进行自动化构建&amp;部署</p></blockquote><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">https</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//serverless-api-elog.vercel.app/api/github?user=xxx&amp;repo=xxx&amp;event_type=xxx&amp;token=xxx</span></span>
<span class="line"></span></code></pre></div><h3 id="配置package-json" tabindex="-1">配置package.json <a class="header-anchor" href="#配置package-json" aria-hidden="true">#</a></h3><p>在自动化流程中不要忘记将@elog/cli安装到package.json</p><blockquote><p>npm i @elog/cli<br> 或者<br> yarn add @elog/cli<br> 或者<br> pnpm i @elog/cli</p></blockquote><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">scripts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">build</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">vitepress or hexo 或者其他自定义的命令，具体以自己的工具为准</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 构建文档</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">elog:init</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">elog init</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">sync:local</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">elog sync -e .elog.env</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 本地同步时需要从env中取值</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">sync</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">elog sync</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 进行同步</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">clean</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">elog clean</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="github-actions" tabindex="-1">Github Actions <a class="header-anchor" href="#github-actions" aria-hidden="true">#</a></h3><ol><li>在仓库的<code>设置-Secrets and variables-Actions-Secrets</code>中进行配置需要用到的环境变量</li><li>在仓库根目录创建<code>.github/workflows/main.yaml</code>文件，并按照以下流程配置</li></ol><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">Deplo To Github Pages</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF9CAC;">on</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;"># 允许手动push触发</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">push</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">branches</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">master</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;"># 允许外部仓库事件触发</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">repository_dispatch</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">types</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;"># api中的event_type就是这个</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">deploy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">jobs</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">build</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">runs-on</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">ubuntu-latest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">steps</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">检查分支</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">actions/checkout@master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">安装node环境</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">actions/setup-node@master</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">node-version</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">16.x</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">安装依赖</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          export TZ=&#39;Asia/Shanghai&#39;</span></span>
<span class="line"><span style="color:#C3E88D;">          npm install --prod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">拉取语雀/Notion的文章</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">env</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 语雀相关环境变量</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">YUQUE_TOKEN</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.YUQUE_TOKEN }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">YUQUE_LOGIN</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.YUQUE_LOGIN }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">YUQUE_REPO</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.YUQUE_REPO }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># Notion相关环境变量</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">NOTION_TOKEN</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.NOTION_TOKEN }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">NOTION_DATABASE_ID</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.NOTION_DATABASE_ID }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 图床相关环境变量，以腾讯云COS为例</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">COS_SECRET_ID</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.COS_SECRET_ID }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">COS_SECRET_KEY</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.COS_SECRET_KEY }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">COS_IMAGE_BUCKET</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.COS_IMAGE_BUCKET }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">COS_IMAGE_REGION</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.COS_IMAGE_REGION }}</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          # 对应package.json中的script.sync</span></span>
<span class="line"><span style="color:#C3E88D;">          npm run sync</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">配置Git用户名邮箱</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          git config --global user.name &quot;xxxx&quot;</span></span>
<span class="line"><span style="color:#C3E88D;">          git config --global user.email &quot;xxxx&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">提交yuque拉取的文章到GitHub仓库</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          echo \`date +&quot;%Y-%m-%d %H:%M:%S&quot;\` begin &gt; time.txt</span></span>
<span class="line"><span style="color:#C3E88D;">          git add .</span></span>
<span class="line"><span style="color:#C3E88D;">          git commit -m &quot;更新文档&quot; -a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">推送文章到仓库</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">ad-m/github-push-action@master</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># GITHUB_TOKEN为流水线内置变量，无需配置，可直接使用</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">github_token</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.GITHUB_TOKEN }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">生成静态文件</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          # 对应package.json中的script.build</span></span>
<span class="line"><span style="color:#C3E88D;">          npm run build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">部署到Github Pages</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">peaceiris/actions-gh-pages@v3</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># github_token和personal_token适用于推送到当前仓库</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 也就是你的Github Pages仓库（xxxx/xxxx.github.io）</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 一般都不直接在Github Pages仓库开发，所以推荐使用deploy_key</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># github_token: \${{ secrets.GITHUB_TOKEN }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># personal_token: \${{ secrets.PERSONAL_TOKEN }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># deploy_key可以推送到别的仓库, SSH_PRIVATE_KEY 为自己电脑的ssh私钥</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">deploy_key</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.SSH_PRIVATE_KEY }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 具体目录以自己实际情况为准</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">publish_dir</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">docs/.vitepress/dist</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">external_repository</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">xxxx/xxxx.github.io</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">publish_branch</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">master</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">commit_message</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ github.event.head_commit.message }}</span></span>
<span class="line"></span></code></pre></div><h2 id="notion示例" tabindex="-1">Notion示例 <a class="header-anchor" href="#notion示例" aria-hidden="true">#</a></h2><p><strong>Notion + Slack + pipedream + serverless api + GitHub actions + Github Pages 持续集成</strong></p><p><img src="https://blogimagesrep-1257180516.cos.ap-guangzhou.myqcloud.com/elog-docs-images/3a950872cf389482fb698f35ece602f1.png" alt="Untitled.png"></p><h3 id="配置数据表-slack-notifications" tabindex="-1">配置数据表 <strong>Slack notifications</strong> <a class="header-anchor" href="#配置数据表-slack-notifications" aria-hidden="true">#</a></h3><p>设置数据表文档字段被扭转到某个状态时向Slack发送消息</p><p><img src="https://blogimagesrep-1257180516.cos.ap-guangzhou.myqcloud.com/elog-docs-images/2e89d5df627c93e7ef093d3888852d33.png" alt="Untitled.png"></p><h3 id="注册slack账号并授权给notion" tabindex="-1">注册Slack账号并授权给Notion <a class="header-anchor" href="#注册slack账号并授权给notion" aria-hidden="true">#</a></h3><p>当Notion数据表的文档字段被扭转到某个状态时向Slack发送消息，此时Slack收到消息提醒</p><p><img src="https://blogimagesrep-1257180516.cos.ap-guangzhou.myqcloud.com/elog-docs-images/58a8aa630704f280a5fe5ce72a5e00fb.png" alt="Untitled.png"></p><h3 id="serverless-api-1" tabindex="-1"><strong>serverless api</strong> <a class="header-anchor" href="#serverless-api-1" aria-hidden="true">#</a></h3><p>为了方便，这里提供一个部署在Vercel的免费公用的<a href="https://github.com/elog-x/serverless-api" target="_blank" rel="noreferrer">ServerlessAPI</a></p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">https</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//serverless-api-elog.vercel.app/api/github?user=xxx&amp;repo=xxx&amp;event_type=xxx&amp;token=xxx</span></span>
<span class="line"></span></code></pre></div><h3 id="注册pipedream并配置workflow" tabindex="-1">注册<strong>pipedream并配置WorkFlow</strong> <a class="header-anchor" href="#注册pipedream并配置workflow" aria-hidden="true">#</a></h3><h4 id="第一步-选择channels为notion应用" tabindex="-1">第一步：选择Channels为Notion应用 <a class="header-anchor" href="#第一步-选择channels为notion应用" aria-hidden="true">#</a></h4><blockquote><p>你也可以在Notion中配置发送消息到某个频道，然后在pipedream选择所选频道的Channel。支持多选Channels</p></blockquote><p><img src="https://blogimagesrep-1257180516.cos.ap-guangzhou.myqcloud.com/elog-docs-images/b0308ef0043abae5ca865e09f58608f7.png" alt="Untitled.png"></p><h4 id="第二步-收到notion消息后发送自定义http请求" tabindex="-1">第二步：收到Notion消息后发送自定义Http请求 <a class="header-anchor" href="#第二步-收到notion消息后发送自定义http请求" aria-hidden="true">#</a></h4><p>将调用Github Actions的 serverless api 填入即可</p><p><img src="https://blogimagesrep-1257180516.cos.ap-guangzhou.myqcloud.com/elog-docs-images/707b235e4cbf7b781dd29e1ef559e5a3.png" alt="Untitled.png"></p><h3 id="配置package-json-1" tabindex="-1">配置package.json <a class="header-anchor" href="#配置package-json-1" aria-hidden="true">#</a></h3><p>在自动化流程中不要忘记将@elog/cli安装到package.json</p><blockquote><p>npm i @elog/cli<br> 或者<br> yarn add @elog/cli<br> 或者<br> pnpm i @elog/cli</p></blockquote><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">scripts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">build</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">vitepress or hexo 或者其他自定义的命令，具体以自己的工具为准</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 构建文档</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">elog:init</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">elog init</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">sync:local</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">elog sync -e .elog.env</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 本地同步时需要从env中取值</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">sync</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">elog sync</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// 进行同步</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">clean</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">elog clean</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="github-actions-1" tabindex="-1">Github Actions <a class="header-anchor" href="#github-actions-1" aria-hidden="true">#</a></h3><ol><li>在仓库的<code>设置-Secrets and variables-Actions-Secrets</code>中进行配置需要用到的环境变量</li><li>在仓库根目录创建<code>.github/workflows/main.yaml</code>文件，并按照以下流程配置</li></ol><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">Deplo To Github Pages</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF9CAC;">on</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;"># 允许手动push触发</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">push</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">branches</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">master</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;"># 允许外部仓库事件触发</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">repository_dispatch</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">types</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;"># api中的event_type就是这个</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">deploy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">jobs</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">build</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">runs-on</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">ubuntu-latest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">steps</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">检查分支</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">actions/checkout@master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">安装node环境</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">actions/setup-node@master</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">node-version</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">16.x</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">安装依赖</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          export TZ=&#39;Asia/Shanghai&#39;</span></span>
<span class="line"><span style="color:#C3E88D;">          npm install --prod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">拉取语雀/Notion的文章</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">env</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 语雀相关环境变量</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">YUQUE_TOKEN</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.YUQUE_TOKEN }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">YUQUE_LOGIN</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.YUQUE_LOGIN }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">YUQUE_REPO</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.YUQUE_REPO }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># Notion相关环境变量</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">NOTION_TOKEN</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.NOTION_TOKEN }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">NOTION_DATABASE_ID</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.NOTION_DATABASE_ID }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 图床相关环境变量，以腾讯云COS为例</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">COS_SECRET_ID</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.COS_SECRET_ID }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">COS_SECRET_KEY</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.COS_SECRET_KEY }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">COS_IMAGE_BUCKET</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.COS_IMAGE_BUCKET }}</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">COS_IMAGE_REGION</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.COS_IMAGE_REGION }}</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          # 对应package.json中的script.sync</span></span>
<span class="line"><span style="color:#C3E88D;">          npm run sync</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">配置Git用户名邮箱</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          git config --global user.name &quot;xxxx&quot;</span></span>
<span class="line"><span style="color:#C3E88D;">          git config --global user.email &quot;xxxx&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">提交yuque拉取的文章到GitHub仓库</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          echo \`date +&quot;%Y-%m-%d %H:%M:%S&quot;\` begin &gt; time.txt</span></span>
<span class="line"><span style="color:#C3E88D;">          git add .</span></span>
<span class="line"><span style="color:#C3E88D;">          git commit -m &quot;更新文档&quot; -a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">推送文章到仓库</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">ad-m/github-push-action@master</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># GITHUB_TOKEN为流水线内置变量，无需配置，可直接使用</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">github_token</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.GITHUB_TOKEN }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">生成静态文件</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">          # 对应package.json中的script.build</span></span>
<span class="line"><span style="color:#C3E88D;">          npm run build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">部署到Github Pages</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">uses</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">peaceiris/actions-gh-pages@v3</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">with</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># github_token和personal_token适用于推送到当前仓库</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 也就是你的Github Pages仓库（xxxx/xxxx.github.io）</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 一般都不直接在Github Pages仓库开发，所以推荐使用deploy_key</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># github_token: \${{ secrets.GITHUB_TOKEN }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># personal_token: \${{ secrets.PERSONAL_TOKEN }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># deploy_key可以推送到别的仓库, SSH_PRIVATE_KEY 为自己电脑的ssh私钥</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">deploy_key</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ secrets.SSH_PRIVATE_KEY }}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;"># 具体目录以自己实际情况为准</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">publish_dir</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">docs/.vitepress/dist</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">external_repository</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">xxxx/xxxx.github.io</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">publish_branch</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">master</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#F07178;">commit_message</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">\${{ github.event.head_commit.message }}</span></span>
<span class="line"></span></code></pre></div>`,48),e=[o];function t(c,r,y,D,i,F){return a(),n("div",null,e)}const A=s(p,[["render",t]]);export{E as __pageData,A as default};
